import express from "express";
import dotenv from "dotenv";
import path from "path";
import { fileURLToPath } from "url";

// 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ Config ‡∏à‡∏≤‡∏Å .env
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 2. Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, "../Front")));

// 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API KEY
if (!process.env.GEMINI_API_KEY) {
  console.error("‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GEMINI_API_KEY ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env ‡∏ô‡∏∞‡∏Ñ‡∏∞!");
  process.exit(1);
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
async function listAvailableModels() {
  const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${process.env.GEMINI_API_KEY}`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    console.log("------------------------------------------");
    console.log("üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:");
    data.models?.forEach(m => console.log(`- ${m.name}`));
    console.log("------------------------------------------");
  } catch (err) {
    console.error("‚ùå ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err.message);
  }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Gemini API (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô 2.0)
async function callGemini(prompt) {
  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ gemini-2.0-flash ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${process.env.GEMINI_API_KEY}`;

  const body = {
    contents: [
      {
        role: "user",
        parts: [
          { 
            text: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤" ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏¥‡πà‡∏á‡πÉ‡∏à‡∏î‡∏µ ‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏°‡∏µ‡∏Ñ‡∏∞/‡∏Ç‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ üíñ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${userMessage}` 
          }
        ]
      }
    ],
    generationConfig: {
      temperature: 0.8,
      topP: 0.95,
      maxOutputTokens: 1024,
    }
  };

  try {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await resp.json();

    if (!resp.ok) {
      console.error("‚ùå Google API Error:", JSON.stringify(data));
      throw new Error(`API Error ${resp.status}`);
    }

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤";

  } catch (error) {
    console.error("‚ùå Server Error:", error.message);
    throw error;
  }
}

// 4. Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏ó
app.post("/chat", async (req, res) => {
  try {
    const { message } = req.body;
    if (!message) return res.json({ reply: "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏´‡∏≤‡∏Ñ‡∏£‡∏π‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏£‡πá‡∏ß üíñ" });

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Prompt ‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤
    const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤" ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏¥‡πà‡∏á‡πÉ‡∏à‡∏î‡∏µ ‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏°‡∏µ‡∏Ñ‡∏∞/‡∏Ç‡∏≤\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${userMessage}`;
    const text = await callGemini(prompt);
    
    // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π
    res.json({ reply: "‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤ üíñ\n" + text });

  } catch (err) {
    res.json({ reply: "‡∏Ñ‡∏£‡∏π‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤ ü•≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + err.message });
  }
});

// 5. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Server
app.listen(PORT, async () => {
  console.log(`‚úÖ Server running at http://localhost:${PORT}`);
  console.log("üîë KEY loaded =", process.env.GEMINI_API_KEY ? "YES" : "NO");
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
  await listAvailableModels();
});